# EfficientSAM3 数据流架构图

本文档详细描述 EfficientSAM3 中 Detector 和 Tracker 的数据流架构。

---

## 1. 整体架构 (Detector + Tracker)

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                        EfficientSAM3 完整数据流 (Detector + Tracker)                         │
└─────────────────────────────────────────────────────────────────────────────────────────────┘

                                        视频输入
                                           │
                     ┌─────────────────────┴─────────────────────┐
                     ▼                                           ▼
               文本提示 "cat"                              每一帧图像
                     │                                           │
                     ▼                                           ▼
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃                                    DETECTOR (98% 参数)                                      ┃
┃                                    概念分割 - 识别"是什么"                                   ┃
┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┫
┃                                                                                            ┃
┃   ┌────────────────┐        ┌────────────────┐        ┌────────────────┐                   ┃
┃   │ Text Encoder   │        │ Vision Encoder │        │Geometry Encoder│                   ┃
┃   │ (MobileCLIP)   │        │   (RepViT)     │        │  (可选点/框)    │                   ┃
┃   │   63.56M       │        │   477.62M      │        │    8.22M       │                   ┃
┃   └───────┬────────┘        └───────┬────────┘        └───────┬────────┘                   ┃
┃           │                         │                         │                            ┃
┃           │   文本特征              │   图像特征              │   几何特征                  ┃
┃           │                         │                         │                            ┃
┃           └─────────┬───────────────┘                         │                            ┃
┃                     │                                         │                            ┃
┃                     │         ┌───────────────────────────────┘                            ┃
┃                     │         │                                                            ┃
┃                     ▼         ▼                                                            ┃
┃           ┌─────────────────────────────┐                                                  ┃
┃           │     torch.cat (拼接)        │                                                  ┃
┃           │   prompt = [text + geo]     │                                                  ┃
┃           └─────────────┬───────────────┘                                                  ┃
┃                         │                                                                  ┃
┃                         ▼                                                                  ┃
┃   ┌─────────────────────────────────────────────────────────────────────────────────────┐  ┃
┃   │                        Transformer Fusion (21.05M)                                  │  ┃
┃   │  ┌─────────────────────────────────────────────────────────────────────────────┐    │  ┃
┃   │  │           Cross-Attention: 图像特征 ←─────→ prompt (文本+几何)               │    │  ┃
┃   │  └─────────────────────────────────────────────────────────────────────────────┘    │  ┃
┃   └─────────────────────────────────────────────────────────────────────────────────────┘  ┃
┃                         │                                                                  ┃
┃                         ▼                                                                  ┃
┃   ┌─────────────────────────────────────────────────────────────────────────────────────┐  ┃
┃   │  Segmentation Head (2.30M)  +  Scoring Module (1.18M)                               │  ┃
┃   └─────────────────────────────────────────────────────────────────────────────────────┘  ┃
┃                         │                                                                  ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
                          │
                          ▼
          ┌───────────────────────────────┐
          │  检测结果: Masks + Scores     │
          │  (哪些像素是"cat")             │
          └───────────────┬───────────────┘
                          │
        ┌─────────────────┼─────────────────┐
        │                 │                 │
        ▼                 ▼                 ▼
   新物体初始化      匹配已有物体       图像backbone特征
        │                 │                 │
        └────────┬────────┘                 │
                 │                          │
                 ▼                          ▼
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃                                    TRACKER (2% 参数)                                       ┃
┃                                   视频追踪 - 跟踪"在哪里"                                   ┃
┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┫
┃                                                                                            ┃
┃                     当前帧图像特征 (来自Detector Backbone)                                  ┃
┃                                    │                                                       ┃
┃   ┌────────────────────────────────┼────────────────────────────────┐                      ┃
┃   │                                ▼                                │                      ┃
┃   │  ┌──────────────────────────────────────────────────────────┐   │                      ┃
┃   │  │           Memory Attention (5.92M)                       │   │                      ┃
┃   │  │  ┌────────────────────────────────────────────────────┐  │   │                      ┃
┃   │  │  │  Cross-Attention: 当前帧 ←──→ 历史记忆 (7帧)        │  │   │                      ┃
┃   │  │  └────────────────────────────────────────────────────┘  │   │                      ┃
┃   │  └──────────────────────────────────────────────────────────┘   │                      ┃
┃   │                                │                                │                      ┃
┃   │          ┌─────────────────────┘                                │                      ┃
┃   │          │                                                      │                      ┃
┃   │          │  ┌──────────────────────────────────────────┐        │                      ┃
┃   │          │  │          记忆库 (Memory Bank)            │        │                      ┃
┃   │          │  │  ┌─────┬─────┬─────┬─────┬─────┬─────┐   │        │                      ┃
┃   │          │  │  │ t-6 │ t-5 │ t-4 │ t-3 │ t-2 │ t-1 │   │        │                      ┃
┃   │          │  │  └─────┴─────┴─────┴─────┴─────┴─────┘   │        │                      ┃
┃   │          │  │  maskmem_features + obj_ptr              │        │                      ┃
┃   │          │  └────────────────────────────▲─────────────┘        │                      ┃
┃   │          │                               │                      │                      ┃
┃   └──────────┼───────────────────────────────┼──────────────────────┘                      ┃
┃              │                               │                                             ┃
┃              ▼                               │                                             ┃
┃      融合后的图像特征                         │                                             ┃
┃              │                               │                                             ┃
┃              │     ┌─────────────────────────┼────────────────────┐                        ┃
┃              │     │                         │                    │                        ┃
┃              │     ▼                         │                    ▼                        ┃
┃              │  用户点击修正              存入记忆            上一帧Mask                    ┃
┃              │  (可选)                       │               (迭代)                        ┃
┃              │     │                         │                    │                        ┃
┃              │     └────────────┬────────────┼────────────────────┘                        ┃
┃              │                  │            │                                             ┃
┃              │                  ▼            │                                             ┃
┃              │      ┌─────────────────────┐  │                                             ┃
┃              │      │ SAM Prompt Encoder  │  │                                             ┃
┃              │      │      (0.01M)        │  │                                             ┃
┃              │      └──────────┬──────────┘  │                                             ┃
┃              │                 │             │                                             ┃
┃              │    sparse_emb + dense_emb    │                                             ┃
┃              │                 │             │                                             ┃
┃              └────────┬────────┘             │                                             ┃
┃                       │                      │                                             ┃
┃                       ▼                      │                                             ┃
┃           ┌─────────────────────┐            │                                             ┃
┃           │  SAM Mask Decoder   │            │                                             ┃
┃           │      (4.22M)        │            │                                             ┃
┃           └──────────┬──────────┘            │                                             ┃
┃                      │                       │                                             ┃
┃           ┌──────────┼──────────┐            │                                             ┃
┃           ▼          ▼          ▼            │                                             ┃
┃       预测Mask    IoU分数   Obj Score        │                                             ┃
┃           │                                  │                                             ┃
┃           ▼                                  │                                             ┃
┃   ┌─────────────────────┐                    │                                             ┃
┃   │  Memory Encoder     │────────────────────┘                                             ┃
┃   │   (1.38M)           │   maskmem_features                                               ┃
┃   └─────────────────────┘                                                                  ┃
┃                                                                                            ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
                          │
                          ▼
          ┌───────────────────────────────┐
          │    最终输出: 追踪 Masks       │
          │    每帧每个物体的分割结果       │
          └───────────────────────────────┘
```

---

## 2. Detector 三种 Encoder 融合机制

### 2.1 融合流程图

```
   Text Encoder          Geometry Encoder         Vision Encoder
   (MobileCLIP)                                     (RepViT)
        │                       │                       │
        ▼                       ▼                       │
  (seq_len, B, 256)       (n_geo, B, 256)              │
        │                       │                       │
        └───────────┬───────────┘                       │
                    │                                   │
                    ▼                                   │
              torch.cat()                               │
                    │                                   │
                    ▼                                   ▼
        prompt: (seq+geo, B, 256)          img_feats: (H*W, B, 256)
                    │                                   │
                    └─────────────┬─────────────────────┘
                                  │
                                  ▼
                    ┌─────────────────────────────┐
                    │   Transformer Encoder       │
                    │   Cross-Attention:          │
                    │   Q=img, K/V=prompt         │
                    │   或 Q=prompt, K/V=img      │
                    └─────────────────────────────┘
                                  │
                                  ▼
                          融合后的特征
```

### 2.2 融合方式说明

| 融合步骤 | 方式 | 参与者 | 代码位置 |
|---------|------|--------|---------|
| **Step 1** | `torch.cat()` 拼接 | Text + Geometry → prompt | `sam3_image.py:207` |
| **Step 2** | Cross-Attention | prompt ↔ Vision | `encoder.py:513-577` |

### 2.3 各 Encoder 输出形状

| Encoder | 输出形状 | 说明 |
|---------|---------|------|
| Text Encoder | `(seq_len, B, 256)` | 文本序列特征，seq_len 为 token 数量 |
| Geometry Encoder | `(n_geo, B, 256)` | 几何提示特征，n_geo 为点/框数量 |
| Vision Encoder | `(H*W, B, 256)` | 图像特征，H*W 为空间分辨率 |
| 拼接后的 prompt | `(seq_len + n_geo, B, 256)` | 统一的条件序列 |

### 2.4 设计原理

- **Text 和 Geometry 都是"条件信息"**：描述"分割什么"(文本)和"在哪里"(几何)
- **Vision 是"主体"**：图像内容本身
- **Cross-Attention 实现语义对齐**：让图像特征关注相关的文本/几何条件

---

## 3. Tracker 数据流

```
                        当前帧图像特征
                    (来自 Detector Backbone)
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      Memory Attention (transformer)                          │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  Cross-Attention: 当前帧特征 ←→ 历史记忆 (过去7帧)                    │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│         ↑                                                                   │
│    maskmem_features (来自历史帧)                                             │
│    maskmem_tpos_enc (时序位置编码)                                           │
│    obj_ptr (物体指针)                                                        │
└─────────────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                      融合后的图像特征
                              │
     ┌────────────────────────┴────────────────────────┐
     │                                                 │
     ▼                                                 ▼
┌──────────────────┐                          ┌──────────────────┐
│  用户交互提示     │                          │    上一帧Mask     │
│  (点/框/掩码)     │                          │   (迭代修正)      │
└──────────────────┘                          └──────────────────┘
           │                                           │
           └─────────────────┬─────────────────────────┘
                             ▼
                 ┌──────────────────────┐
                 │ SAM Prompt Encoder   │
                 │  - sparse_embeddings │ ← 点/框编码
                 │  - dense_embeddings  │ ← 掩码编码
                 └──────────────────────┘
                             │
                             ▼
                 ┌──────────────────────┐
                 │  SAM Mask Decoder    │
                 │  (Two-Way Attention) │
                 └──────────────────────┘
                             │
              ┌──────────────┼──────────────┐
              ▼              ▼              ▼
         低分辨率Mask    IoU分数      Object Score
              │
              ▼
         高分辨率Mask (输出)
              │
              ▼
        ┌──────────────────────┐
        │  Memory Encoder      │
        │  (maskmem_backbone)  │
        └──────────────────────┘
              │
              ▼
        maskmem_features ──────→ 存入记忆库 (供下一帧使用)
```

---

## 4. Detector vs Tracker 对比

| 特性 | Detector | Tracker |
|------|----------|---------|
| **参数占比** | 98% (573.93M) | 2% (11.74M) |
| **输入** | 图像 + 文本 + 几何提示 | 图像 + 用户点击 + 历史记忆 |
| **融合方式** | 文本-图像 Cross-Attention | 当前帧-历史帧 Memory Attention |
| **输出** | 概念分割 Mask + 置信度 | 追踪 Mask + IoU分数 |
| **时序建模** | 无 | 有 (7帧记忆) |
| **主要功能** | 识别"是什么" | 跟踪"在哪里" |

---

## 5. 协作流程

| 阶段 | Detector 职责 | Tracker 职责 |
|------|--------------|--------------|
| **第1帧** | 根据文本找到所有目标 | 初始化追踪目标 |
| **后续帧** | 持续检测新出现的目标 | 追踪已有目标的位置 |
| **匹配** | 提供检测框+分数 | 与已有目标做IoU匹配 |
| **记忆** | 无 | 保存7帧历史记忆 |
| **修正** | 无 | 接收用户点击修正 |

---

## 6. 共享资源

- **Vision Encoder (RepViT)**: Detector 和 Tracker 共用图像特征
- Tracker 不重复计算图像特征，直接使用 Detector Backbone 输出
